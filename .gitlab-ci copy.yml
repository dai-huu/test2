stages:
  - build
  - update-manifest

variables:
  DOCKER_TLS_CERTDIR: ""
  SHORT_TAG: "${CI_COMMIT_SHORT_SHA}"

.default:
  image: docker:24
  services:
    - docker:dind
  before_script:
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

###########################################
# Build tất cả microservices
###########################################

# Template chung cho các job build để tránh lặp code
.build_template:
  extends: .default
  stage: build
  script:
    # Biến SERVICE_NAME phải được định nghĩa trong từng job cụ thể
    - docker build -f ${SERVICE_NAME}/Dockerfile -t ${DOCKERHUB_USERNAME}/${SERVICE_NAME}:latest ${SERVICE_NAME}/
    - docker tag ${DOCKERHUB_USERNAME}/${SERVICE_NAME}:latest ${DOCKERHUB_USERNAME}/${SERVICE_NAME}:${SHORT_TAG}
    - docker push ${DOCKERHUB_USERNAME}/${SERVICE_NAME}:latest
    - docker push ${DOCKERHUB_USERNAME}/${SERVICE_NAME}:${SHORT_TAG}
    # Tạo marker file để job sau biết service này đã được build
    - mkdir -p built_services
    - touch built_services/${SERVICE_NAME}
  artifacts:
    paths:
      - built_services/
    expire_in: 1 hour

build_client:
  extends: .build_template
  variables:
    SERVICE_NAME: client
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - client/**
        - common/**
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - client/**
        - common/**
      when: on_success
    - when: never # Ngăn không cho chạy trong các trường hợp khác

build_tickets:
  extends: .build_template
  variables:
    SERVICE_NAME: tickets
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - tickets/**
        - common/**
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - tickets/**
        - common/**
      when: on_success
    - when: never

build_orders:
  extends: .build_template
  variables:
    SERVICE_NAME: orders
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - orders/**
        - common/**
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - orders/**
        - common/**
      when: on_success
    - when: never

build_payments:
  extends: .build_template
  variables:
    SERVICE_NAME: payments
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - payments/**
        - common/**
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - payments/**
        - common/**
      when: on_success
    - when: never

build_auth:
  extends: .build_template
  variables:
    SERVICE_NAME: auth
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - auth/**
        - common/**
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - auth/**
        - common/**
      when: on_success
    - when: never

build_expiration:
  extends: .build_template
  variables:
    SERVICE_NAME: expiration
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - expiration/**
        - common/**
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - expiration/**
        - common/**
      when: on_success
    - when: never

###########################################
# Update Kubernetes Manifests with changes
###########################################

update_manifest:
  stage: update-manifest
  image: alpine:3.18
  # Sử dụng needs để lấy artifacts từ tất cả các job build
  needs:
    - job: build_client
      optional: true # Job là tùy chọn, pipeline không fail nếu job này không chạy
    - job: build_tickets
      optional: true
    - job: build_orders
      optional: true
    - job: build_payments
      optional: true
    - job: build_auth
      optional: true
    - job: build_expiration
      optional: true
  rules:
    # Job này chỉ chạy trên nhánh chính (main/master) và khi có thay đổi trong các thư mục liên quan
    - if: '$CI_COMMIT_BRANCH == "main" && (CI_PIPELINE_SOURCE != "schedule")'
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git bash yq
    - git config --global user.email "ci@gitlab.local"
    - git config --global user.name "GitLab CI"
    - git config --global http.sslVerify false
  script:
    - |
      # Kiểm tra xem có service nào được build không
      if [ ! -d "built_services" ] || [ -z "$(ls -A built_services)" ]; then
        echo "No services were built in the previous stage. Nothing to update."
        exit 0
      fi

    - git remote set-url origin "http://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git fetch origin
    - git checkout "$CI_COMMIT_REF_NAME" || git checkout -b "$CI_COMMIT_REF_NAME"
    - git pull origin "$CI_COMMIT_REF_NAME"

    - SHORT_TAG="$CI_COMMIT_SHORT_SHA"
    - echo "Updating manifests with tag $SHORT_TAG..."
    - echo "Services to be updated:"
    - ls built_services

    - |
      # Vòng lặp chỉ duyệt qua các service đã được build (dựa trên artifact files)
      for service in $(ls built_services); do
        FILE="infra/k8s/${service}-depl.yaml"

        if [ -f "$FILE" ]; then
          echo "------------------------------------------------"
          echo "Processing $service -> $FILE"
          
          # [DEBUG] In ra dòng image hiện tại
          echo "Current content:"
          grep "image:" "$FILE"

          # Update image bằng yq
          NEW_IMAGE="${DOCKERHUB_USERNAME}/${service}:${SHORT_TAG}"
          yq eval -i "(.spec.template.spec.containers[] | select(.name == \"${service}\")).image = \"${NEW_IMAGE}\"" "$FILE"
          
          # [DEBUG] In ra kết quả sau khi update
          echo "New content:"
          grep "image:" "$FILE"
        else
          echo "Warning: File $FILE not found for built service '$service'."
        fi
      done
      echo "------------------------------------------------"

    # Commit
    - git add infra/k8s
    - |
      if ! git diff --cached --quiet; then
        echo "Changes detected. Committing..."
        git commit -m "Update image tags to $SHORT_TAG for built services [skip ci]"
        git push origin "$CI_COMMIT_REF_NAME"
      else
        echo "No changes were made to the manifest files. Nothing to commit."
        exit 0
      fi